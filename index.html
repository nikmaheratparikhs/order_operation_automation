<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Processor Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .log-container::-webkit-scrollbar {
            width: 8px;
        }

        .log-container::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }

        .log-container::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .input-field {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            color: white;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.8);
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-6">

    <div
        class="glass-panel w-full max-w-6xl rounded-2xl p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 relative overflow-hidden">
        <!-- Glows -->
        <div
            class="absolute top-0 right-0 -mt-20 -mr-20 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-pulse-slow">
        </div>
        <div
            class="absolute bottom-0 left-0 -mb-20 -ml-20 w-80 h-80 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-pulse-slow">
        </div>

        <!-- Left Column: Controls (Span 5) -->
        <div class="col-span-1 lg:col-span-5 flex flex-col space-y-5 z-10">
            <div>
                <h1
                    class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400 mb-1">
                    Invoice AI</h1>
                <p class="text-slate-400 text-sm">SKU Data Enrichment & Image Stamping</p>
            </div>

            <!-- API Configuration -->
            <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/50 space-y-3">
                <h3 class="text-xs font-bold text-blue-400 uppercase tracking-wider">Google Sheets API Config</h3>
                <div class="space-y-2">
                    <label class="block">
                        <span class="text-xs text-slate-400">Spreadsheet ID</span>
                        <input type="text" id="sheetId" value="1WESHMsygDpGdw1xqOlmY8OWAtNAhWRQBgBd6vSi1Nu4"
                            class="input-field w-full">
                    </label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="block">
                            <span class="text-xs text-slate-400">Range</span>
                            <input type="text" id="sheetRange" value="Sheet1" class="input-field w-full">
                        </label>
                        <!-- <label class="block">
                            <span class="text-xs text-slate-400">API Key</span>
                            <input type="text" id="apiKey" value="AIzaSyAN47m9DL1MU4kw-NdzK7ZQ6vLhyZQZ5-U"
                                class="input-field w-full">
                        </label> -->
                    </div>
                </div>
            </div>

            <!-- Positioning Configuration -->
            <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/50 space-y-3" style="display: none;">
                <h3 class="text-xs font-bold text-green-400 uppercase tracking-wider">PDF Layout Settings</h3>

                <!-- Text Settings -->
                <div class="border-b border-slate-700/50 pb-3">
                    <span class="text-xs font-semibold text-slate-300 block mb-2">Text Stamping</span>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-2">
                            <span class="text-xs text-slate-400 w-8">X Pos:</span>
                            <input type="number" id="textX" value="190" class="input-field w-full">
                        </label>
                        <label class="flex items-center space-x-2">
                            <span class="text-xs text-slate-400 w-8">Y Pos:</span>
                            <input type="number" id="textY" value="250" class="input-field w-full">
                        </label>
                    </div>
                </div>

                <!-- Image Settings -->
                <div>
                    <span class="text-xs font-semibold text-slate-300 block mb-2">Image Stamping</span>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <label class="flex items-center space-x-2">
                            <span class="text-xs text-slate-400 w-8">X Pos:</span>
                            <input type="number" id="imgX" value="400" class="input-field w-full">
                        </label>
                        <label class="flex items-center space-x-2">
                            <span class="text-xs text-slate-400 w-8">Y Pos:</span>
                            <input type="number" id="imgY" value="190" class="input-field w-full">
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-2">
                            <span class="text-xs text-slate-400 w-8">Width:</span>
                            <input type="number" id="imgW" value="100" class="input-field w-full">
                        </label>
                        <label class="flex items-center space-x-2">
                            <span class="text-xs text-slate-400 w-8">Height:</span>
                            <input type="number" id="imgH" value="100" class="input-field w-full">
                        </label>
                    </div>
                </div>
            </div>

            <!-- Upload Zone -->
            <div id="dropZone"
                class="border-2 border-dashed border-slate-600 rounded-xl p-6 text-center hover:border-blue-500 hover:bg-slate-800/30 transition-all cursor-pointer group">
                <div class="mb-2">
                    <svg class="w-8 h-8 mx-auto text-slate-500 group-hover:text-blue-400 transition-colors" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                        </path>
                    </svg>
                </div>
                <p class="text-slate-300 text-sm font-medium">Upload Invoice PDF</p>
                <input type="file" id="fileInput" accept="application/pdf" class="hidden">
            </div>

            <button id="processBtn" disabled
                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-900/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95">
                Process Invoice
            </button>
            <a id="downloadBtn" style="display:none;"
                class="block w-full text-center bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-900/50 transition-all cursor-pointer">
                Download PDF
            </a>
        </div>

        <!-- Right Column: Logs (Span 7) -->
        <div class="col-span-1 lg:col-span-7 h-[760px] flex flex-col z-10">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-slate-200">Processing Log</h3>
                <span id="statusIndicator"
                    class="px-2 py-1 rounded text-[10px] font-mono bg-slate-800 text-slate-400">READY</span>
            </div>
            <div id="logContainer"
                class="log-container flex-1 bg-slate-950/80 rounded-xl p-4 overflow-y-auto font-mono text-xs leading-relaxed border border-slate-800">
                <div class="text-slate-500 italic">Logs will appear here...</div>
            </div>
        </div>
    </div>

    <script>
        // --- User Configuration ---
        const SKU_MATCH_COLUMNS = ['JG SKU 1', 'JG SKU 2', 'Vendor SKU']; // Columns to check for SKU matches
        const IMAGE_MATCH_COLUMN = 'Image'; // Column header for Image URL
        const DETAIL_COLUMNS = {
            box: 'Box',
            bag: 'Bag',
            stock: 'Current Stock'
        };
        // --------------------------

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const logContainer = document.getElementById('logContainer');

        // Inputs
        const sheetIdInput = document.getElementById('sheetId');
        const sheetRangeInput = document.getElementById('sheetRange');
        // const apiKeyInput = document.getElementById('apiKey');
        const apiKeyInput = "AIzaSyAN47m9DL1MU4kw-NdzK7ZQ6vLhyZQZ5-U";
        const textXInput = document.getElementById('textX');
        const textYInput = document.getElementById('textY');
        const imgXInput = document.getElementById('imgX');
        const imgYInput = document.getElementById('imgY');
        const imgWInput = document.getElementById('imgW');
        const imgHInput = document.getElementById('imgH');

        let currentFile = null;
        let sheetDataMap = null;

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            let colorClass = 'text-slate-300';
            if (type === 'error') colorClass = 'text-red-400 font-bold';
            if (type === 'success') colorClass = 'text-emerald-400';
            if (type === 'warn') colorClass = 'text-amber-400';

            entry.className = `mb-1 pl-2 border-l-2 ${type === 'error' ? 'border-red-500' : 'border-blue-500/30'} ${colorClass}`;
            entry.innerHTML = `<span class="opacity-40 mr-2">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // --- File Handling ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-slate-800/50'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-blue-500', 'bg-slate-800/50'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-slate-800/50');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            if (file.type !== 'application/pdf') { log('Error: Please upload a PDF file.', 'error'); return; }
            currentFile = file;
            log(`File loaded: ${file.name}`, 'success');
            processBtn.disabled = false;
            dropZone.querySelector('p').textContent = file.name;
        }

        async function fetchSheetData(id, range) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${range}?key=AIzaSyAN47m9DL1MU4kw-NdzK7ZQ6vLhyZQZ5-U`;
            log(`Fetching data from Sheets API...`, 'info');

            try {
                const response = await axios.get(url);
                const data = response.data;
                if (!data.values || data.values.length < 2) throw new Error("Invalid structure: No values found in sheet.");

                const rows = data.values;
                const headers = rows[0].map(h => h.trim().toLowerCase()); // Normalize headers
                const map = new Map();

                // Dynamic Column Mapping
                // 1. Find indices for SKU columns
                const skuIndices = [];
                SKU_MATCH_COLUMNS.forEach(colName => {
                    const idx = headers.indexOf(colName.toLowerCase());
                    if (idx !== -1) skuIndices.push(idx);
                });

                if (skuIndices.length === 0) {
                    log(`Warning: None of the configured SKU columns (${SKU_MATCH_COLUMNS.join(', ')}) were found in headers.`, 'error');
                    throw new Error("No matching SKU columns found.");
                } else {
                    log(`Found SKU columns: ${skuIndices.length} matches.`, 'info');
                }

                // 2. Find indices for Detail columns
                const detailIndices = {};
                for (const [key, colName] of Object.entries(DETAIL_COLUMNS)) {
                    const idx = headers.indexOf(colName.toLowerCase());
                    detailIndices[key] = idx;
                    if (idx === -1) log(`Warning: Detail Column '${colName}' not found. '${key}' will be empty.`, 'warn');
                }

                // 3. Find index for Image
                const imageIndex = headers.indexOf(IMAGE_MATCH_COLUMN.toLowerCase());
                if (imageIndex === -1) log(`Warning: Image Column '${IMAGE_MATCH_COLUMN}' not found.`, 'warn');

                // 4. Build Map
                const dataRows = rows.slice(1);
                dataRows.forEach(row => {
                    const details = {
                        box: detailIndices.box !== -1 ? (row[detailIndices.box] || 'N/A') : 'N/A',
                        bag: detailIndices.bag !== -1 ? (row[detailIndices.bag] || 'N/A') : 'N/A',
                        stock: detailIndices.stock !== -1 ? (row[detailIndices.stock] || '0') : '0',
                        imageUrl: imageIndex !== -1 ? (row[imageIndex] || null) : null
                    };

                    skuIndices.forEach(index => {
                        const sku = row[index]?.trim();
                        if (sku && sku.length > 0) {
                            map.set(sku, details);
                        }
                    });
                });

                log(`Database indexed: ${map.size} SKU references using columns: ${SKU_MATCH_COLUMNS.join(', ')}`, 'success');
                return map;
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function fetchImageBytes(url) {
            try {
                // If url not absolute, skip
                if (!url.startsWith('http')) return null;
                const response = await axios.get(url, { responseType: 'arraybuffer' });
                return response.data;
            } catch (error) {
                log(`Failed to load image [${url}]: ${error.message}`, 'warn');
                return null;
            }
        }

        // --- Core Process ---
        processBtn.addEventListener('click', async () => {
            if (!currentFile) return;

            // Get Config Values
            const id = sheetIdInput.value.trim();
            const range = sheetRangeInput.value.trim();
            // Coords
            const txtX = parseFloat(textXInput.value) || 400;
            const txtY = parseFloat(textYInput.value) || 750;
            const imgX = parseFloat(imgXInput.value) || 50;
            const imgY = parseFloat(imgYInput.value) || 650;
            const imgW = parseFloat(imgWInput.value) || 100;
            const imgH = parseFloat(imgHInput.value) || 100;

            if (!id) { log('Missing API Credentials', 'error'); return; }

            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';

            try {
                // 1. Fetch Data
                if (!sheetDataMap) sheetDataMap = await fetchSheetData(id, range);

                // 2. Clone Buffers
                const originalBuffer = await currentFile.arrayBuffer();
                const bufferForPdfJs = originalBuffer.slice(0);
                const bufferForPdfLib = originalBuffer.slice(0);

                // 3. Scan PDF
                log('Scanning PDF for SKUs...', 'info');
                const loadingTask = pdfjsLib.getDocument(bufferForPdfJs);
                const pdf = await loadingTask.promise;
                const numPages = pdf.numPages;

                // 4. Modify PDF
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const pdfDoc = await PDFDocument.load(bufferForPdfLib);
                const helveticaFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                const pages = pdfDoc.getPages();

                let matchCount = 0;

                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const textItems = textContent.items.map(item => item.str).join(' ');
                    const potentialSkus = textItems.match(/\b[A-Za-z0-9-]{5,}\b/g) || [];

                    let foundSku = null;
                    let details = null;

                    for (const candidate of potentialSkus) {
                        if (sheetDataMap.has(candidate)) {
                            foundSku = candidate; details = sheetDataMap.get(candidate); break;
                        }
                        if (sheetDataMap.has(candidate.trim())) {
                            foundSku = candidate.trim(); details = sheetDataMap.get(candidate.trim()); break;
                        }
                    }

                    if (foundSku && details) {
                        log(`Page ${i}: Matched ${foundSku}`, 'success');
                        const pdfPage = pages[i - 1];

                        // Text Drawing (Black only, no background)
                        const infoText = `Box: ${details.box}\nBag: ${details.bag}\nStock: ${details.stock}`;

                        pdfPage.drawText(`SKU: ${foundSku}`, {
                            x: txtX, y: txtY + 20,
                            size: 10, font: helveticaFont, color: rgb(0, 0, 0)
                        });

                        pdfPage.drawText(infoText, {
                            x: txtX, y: txtY,
                            size: 12, font: helveticaFont, color: rgb(0, 0, 0)
                        });

                        // Image Drawing
                        if (details.imageUrl) {
                            log(`   -> Fetching image for ${foundSku}...`, 'info');
                            const imgBytes = await fetchImageBytes(details.imageUrl);
                            if (imgBytes) {
                                let embeddedImage;
                                // Try PNG then JPG
                                try {
                                    embeddedImage = await pdfDoc.embedPng(imgBytes);
                                } catch (e) {
                                    try {
                                        embeddedImage = await pdfDoc.embedJpg(imgBytes);
                                    } catch (e2) {
                                        log(`   -> Image format not supported (must be PNG/JPG).`, 'warn');
                                    }
                                }

                                if (embeddedImage) {
                                    pdfPage.drawImage(embeddedImage, {
                                        x: imgX,
                                        y: imgY,
                                        width: imgW,
                                        height: imgH,
                                    });
                                }
                            }
                        }
                        matchCount++;
                    }
                }

                if (matchCount === 0) log('No matches found.', 'warn');
                else log(`Finished! Modified ${matchCount} pages.`, 'success');

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                downloadBtn.href = url;
                downloadBtn.download = `Processed_${Date.now()}.pdf`;
                downloadBtn.style.display = 'block';

            } catch (err) {
                log(`CRITICAL: ${err.message}`, 'error');
                console.error(err);
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'Process Invoice';
            }
        });
    </script>
</body>

</html>